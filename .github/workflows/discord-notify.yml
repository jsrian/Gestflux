name: Notificar Discord

on:
  push:
<<<<<<< HEAD
  pull_request:
    types: [opened, closed]
=======
    
  pull_request:
    types: [opened, edited, closed, reopened, synchronize]
>>>>>>> develop

jobs:
  notify:
    runs-on: ubuntu-latest
<<<<<<< HEAD
    steps:
      - name: Enviar notificaÃ§Ã£o estilizada ao Discord
        run: |
          EVENT_TYPE="$GITHUB_EVENT_NAME"
          ACTOR="$GITHUB_ACTOR"
          REPO="$GITHUB_REPOSITORY"
          COMMIT_URL="https://github.com/$REPO/commit/$GITHUB_SHA"
          PR_URL=$(jq -r '.pull_request.html_url // empty' "$GITHUB_EVENT_PATH")
          
          # Escolher o texto principal dependendo se Ã© push ou PR
          if [ "$EVENT_TYPE" = "push" ]; then
            TITLE="ðŸ“Œ Novo Push no RepositÃ³rio"
            DESCRIPTION="**UsuÃ¡rio:** $ACTOR fez um push em **$REPO**.\nðŸ”— [Ver Commit]($COMMIT_URL)"
          else
            ACTION=$(jq -r '.action' "$GITHUB_EVENT_PATH")
            if [ "$ACTION" = "opened" ]; then
              TITLE="ðŸ†• Novo Pull Request Aberto"
            elif [ "$ACTION" = "closed" ]; then
              TITLE="ðŸ” Pull Request Fechado"
            else
              TITLE="ðŸ“£ AtualizaÃ§Ã£o no Pull Request"
            fi
            DESCRIPTION="**UsuÃ¡rio:** $ACTOR interagiu com um Pull Request em **$REPO**.\nðŸ”— [Abrir PR]($PR_URL)"
          fi

          JSON=$(jq -n \
            --arg title "$TITLE" \
            --arg description "$DESCRIPTION" \
            --arg actor "$ACTOR" \
            --arg avatar "https://github.com/$ACTOR.png" \
            '{
              "embeds": [
                {
                  "title": $title,
                  "description": $description,
                  "color": 5814783,
                  "author": {
                    "name": $actor,
                    "icon_url": $avatar
                  },
                  "timestamp": (now | todate)
                }
              ]
            }'
          )

          echo "$JSON"

          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$JSON" \
            ${{ secrets.DISCORDHOOK }}
=======

    environment: Configure Discord HOOK

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Gerar payload
        run: |
          ACTOR="$GITHUB_ACTOR"
          REPO="$GITHUB_REPOSITORY"
          EVENT_NAME="$GITHUB_EVENT_NAME"
          ACTION=$(jq -r '.action // empty' "$GITHUB_EVENT_PATH")
          PR_URL=$(jq -r '.pull_request.html_url // empty' "$GITHUB_EVENT_PATH")
          PR_NUMBER=$(jq -r '.pull_request.number // empty' "$GITHUB_EVENT_PATH")
          PR_TITLE=$(jq -r '.pull_request.title // empty' "$GITHUB_EVENT_PATH")
          COMMIT_URL="https://github.com/$REPO/commit/$GITHUB_SHA"
          BRANCH="${GITHUB_REF#refs/heads/}"
          REPO_NAME="${REPO#*/}"
          
          # Obter detalhes dos commits
          BEFORE_SHA=$(jq -r '.before // empty' "$GITHUB_EVENT_PATH")
          
          # Contar commits no push
          if [ "$BEFORE_SHA" != "" ] && [ "$BEFORE_SHA" != "0000000000000000000000000000000000000000" ]; then
            COMMIT_COUNT=$(git rev-list --count $BEFORE_SHA..$GITHUB_SHA)
          else
            COMMIT_COUNT=1
          fi
          
          # Singular ou plural
          if [ "$COMMIT_COUNT" -eq 1 ]; then
            COMMIT_TEXT="commit"
          else
            COMMIT_TEXT="commits"
          fi
          
          COMMIT_MSG=$(git log -1 --pretty=format:'%s')
          COMMIT_HASH_SHORT=$(git log -1 --pretty=format:'%h')

          if [ "$PR_URL" != "" ]; then
            # Obter base e head do PR
            PR_BASE=$(jq -r '.pull_request.base.sha // empty' "$GITHUB_EVENT_PATH")
            PR_HEAD=$(jq -r '.pull_request.head.sha // empty' "$GITHUB_EVENT_PATH")
            
            # Listar todos os commits do PR
            if [ "$PR_BASE" != "" ] && [ "$PR_HEAD" != "" ]; then
              COMMITS_LIST=$(git log --pretty=format:"[\`%h\`](https://github.com/$REPO/commit/%H) %s - %an" $PR_BASE..$PR_HEAD)
            else
              COMMITS_LIST="[\`$COMMIT_HASH_SHORT\`]($COMMIT_URL) $COMMIT_MSG - $ACTOR"
            fi
            
            TITLE="[[$REPO_NAME] Pull Request #$PR_NUMBER $ACTION]($PR_URL)"
            DESC="**$PR_TITLE**\n\n$COMMITS_LIST"
            COLOR=3447003
          else
            # Listar todos os commits do push
            if [ "$BEFORE_SHA" != "" ] && [ "$BEFORE_SHA" != "0000000000000000000000000000000000000000" ]; then
              COMMITS_LIST=$(git log --pretty=format:"[\`%h\`](https://github.com/$REPO/commit/%H) %s - %an" $BEFORE_SHA..$GITHUB_SHA)
            else
              COMMITS_LIST="[$COMMIT_HASH_SHORT]($COMMIT_URL) $COMMIT_MSG - $ACTOR"
            fi
            
            TITLE="[$REPO_NAME:$BRANCH $COMMIT_COUNT new $COMMIT_TEXT]($COMMIT_URL)"
            DESC="$COMMITS_LIST"
            COLOR=5814783
          fi

          jq -n \
            --arg title "$TITLE" \
            --arg desc "$DESC" \
            --arg actor "$ACTOR" \
            --arg avatar "https://github.com/$ACTOR.png" \
            --arg profile "https://github.com/$ACTOR" \
            --argjson color "$COLOR" \
            '{
              embeds: [{
                author: {
                  name: $actor,
                  icon_url: $avatar,
                  url: $profile
                },
                title: $title,
                description: $desc,
                color: $color
              }]
            }' > payload.json

      - name: Enviar para o Discord
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            --data @payload.json \
            "${{ secrets.DISCORDHOOK }}"
>>>>>>> develop
