name: Notificar Discord

on:
  push:
    
  pull_request:
    types: [opened, edited, closed, reopened, synchronize]

jobs:
  notify:
    runs-on: ubuntu-latest

    environment: Configure Discord HOOK

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Gerar payload
        run: |
          ACTOR="$GITHUB_ACTOR"
          REPO="$GITHUB_REPOSITORY"
          EVENT_NAME="$GITHUB_EVENT_NAME"
          ACTION=$(jq -r '.action // empty' "$GITHUB_EVENT_PATH")
          PR_URL=$(jq -r '.pull_request.html_url // empty' "$GITHUB_EVENT_PATH")
          PR_NUMBER=$(jq -r '.pull_request.number // empty' "$GITHUB_EVENT_PATH")
          PR_TITLE=$(jq -r '.pull_request.title // empty' "$GITHUB_EVENT_PATH")
          COMMIT_URL="https://github.com/$REPO/commit/$GITHUB_SHA"
          BRANCH="${GITHUB_REF#refs/heads/}"
          REPO_NAME="${REPO#*/}"
          
          # Obter detalhes dos commits
          BEFORE_SHA=$(jq -r '.before // empty' "$GITHUB_EVENT_PATH")
          
          # Contar commits no push
          if [ "$BEFORE_SHA" != "" ] && [ "$BEFORE_SHA" != "0000000000000000000000000000000000000000" ]; then
            COMMIT_COUNT=$(git rev-list --count $BEFORE_SHA..$GITHUB_SHA)
          else
            COMMIT_COUNT=1
          fi
          
          # Singular ou plural
          if [ "$COMMIT_COUNT" -eq 1 ]; then
            COMMIT_TEXT="commit"
          else
            COMMIT_TEXT="commits"
          fi
          
          COMMIT_MSG=$(git log -1 --pretty=format:'%s')
          COMMIT_HASH_SHORT=$(git log -1 --pretty=format:'%h')

          if [ "$PR_URL" != "" ]; then
            # Mapear aÃ§Ãµes para portuguÃªs
            case "$ACTION" in
              "opened") ACTION_TEXT="aberto" ;;
              "closed") ACTION_TEXT="fechado" ;;
              "reopened") ACTION_TEXT="reaberto" ;;
              "edited") ACTION_TEXT="editado" ;;
              "synchronize") ACTION_TEXT="atualizado" ;;
              *) ACTION_TEXT="$ACTION" ;;
            esac
            
            TITLE="[$REPO_NAME] Pull Request #$PR_NUMBER $ACTION_TEXT"
            DESC="**$PR_TITLE**\nðŸ”— [Ver Pull Request]($PR_URL) - $ACTOR"
            COLOR=3447003
          else
            TITLE="[$REPO_NAME:$BRANCH] $COMMIT_COUNT new $COMMIT_TEXT"
            DESC="[\`$COMMIT_HASH_SHORT\`]($COMMIT_URL) $COMMIT_MSG - $ACTOR"
            COLOR=5814783
          fi

          jq -n \
            --arg title "$TITLE" \
            --arg desc "$DESC" \
            --arg actor "$ACTOR" \
            --arg avatar "https://github.com/$ACTOR.png" \
            --argjson color "$COLOR" \
            '{
              content: $actor,
              embeds: [{
                title: $title,
                description: $desc,
                color: $color
              }]
            }' > payload.json

      - name: Enviar para o Discord
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            --data @payload.json \
            "${{ secrets.DISCORDHOOK }}"
