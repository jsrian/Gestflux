name: Notificar Discord

on:
  push:
  pull_request:
    types: [opened, closed]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Enviar notifica√ß√£o estilizada ao Discord
        run: |
          EVENT_TYPE="$GITHUB_EVENT_NAME"
          ACTOR="$GITHUB_ACTOR"
          REPO="$GITHUB_REPOSITORY"
          COMMIT_URL="https://github.com/$REPO/commit/$GITHUB_SHA"
          PR_URL=$(jq -r '.pull_request.html_url // empty' "$GITHUB_EVENT_PATH")
          
          # Escolher o texto principal dependendo se √© push ou PR
          if [ "$EVENT_TYPE" = "push" ]; then
            TITLE="üìå Novo Push no Reposit√≥rio"
            DESCRIPTION="**Usu√°rio:** $ACTOR fez um push em **$REPO**.\nüîó [Ver Commit]($COMMIT_URL)"
          else
            ACTION=$(jq -r '.action' "$GITHUB_EVENT_PATH")
            if [ "$ACTION" = "opened" ]; then
              TITLE="üÜï Novo Pull Request Aberto"
            elif [ "$ACTION" = "closed" ]; then
              TITLE="üîê Pull Request Fechado"
            else
              TITLE="üì£ Atualiza√ß√£o no Pull Request"
            fi
            DESCRIPTION="**Usu√°rio:** $ACTOR interagiu com um Pull Request em **$REPO**.\nüîó [Abrir PR]($PR_URL)"
          fi

          JSON=$(jq -n \
            --arg title "$TITLE" \
            --arg description "$DESCRIPTION" \
            --arg actor "$ACTOR" \
            --arg avatar "https://github.com/$ACTOR.png" \
            '{
              "embeds": [
                {
                  "title": $title,
                  "description": $description,
                  "color": 5814783,
                  "author": {
                    "name": $actor,
                    "icon_url": $avatar
                  },
                  "timestamp": (now | todate)
                }
              ]
            }'
          )

          echo "$JSON"

          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$JSON" \
            ${{ secrets.DISCORDHOOK }}
